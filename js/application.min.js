/*! getyourbikeback - a project by Julian Hesselbach | Last modified: 2012-07-29 */
(function(a,b,c,d){function g(b,c){this.$road=a("#road"),this.$house_number=a("#house_number"),this.$postcode=a("#postcode"),this.$city=a("#city"),this.$lon=a("#lon"),this.$lat=a("#lat"),this.$suggestions=a("#suggestions"),this.map={},this.markers={},this.markersLayer=!1,this.features=[],this.startLonLat={},this.singleMarker=!1,this.singleHintMarker=!1,this.suggested=[],this.currentPopup=null,this.bounds=new OpenLayers.Bounds,this.mapElement=b,this.$mapElement=a(b),this.options=a.extend({},f,c),this._defaults=f,this._name=e,this.init()}var e="bikemap",f={version:"0.1",baseURL:a.baseURL,mapType:"exploration",startLon:12.380507,startLat:51.343844,zoom:4,mapOptions:{theme:!1,scales:[5e7,3e7,1e7,5e6],projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),resolutions:[1.40625,.703125,.3515625,.17578125,.087890625,.0439453125],minScale:5e7,maxResolution:"auto",maxExtent:new OpenLayers.Bounds(-180,-90,180,90),maxScale:1e7,minResolution:"auto",minExtent:new OpenLayers.Bounds(-1,-1,1,1),numZoomLevels:19,units:"m"}};a.extend(g.prototype,{init:function(){this.options.mapType=this.$mapElement.data("bikemaptype"),this.options.mapOptions=a.extend(this.options.mapOptions,this.options),this.createMap()},createMap:function(){var b=this.$mapElement.parent();this.$mapElement.appendTo(a("body")),this.map=new OpenLayers.Map(this.mapElement,this.options.mapOptions),this.map.addLayer(new OpenLayers.Layer.OSM),this.zoomMapToCenter(this.options.startLon,this.options.startLat),this.newMarkersLayer(),this.addMapFeatures(),this.$mapElement.appendTo(b)},addMapFeatures:function(){switch(this.options.mapType){case"exploration":this.registerDefaultEvents(),this._eventMapMoveZoomEnd(null),this.zoomToBestFit();break;case"report":this.registerReportEvents(),this.geolocate();break;case"report-details":this.drawSingleMarker(this.options.startLon,this.options.startLat),this.registerDefaultEvents();break;case"add-hint":this.drawSingleMarker(this.options.startLon,this.options.startLat),this.registerAddHintEvents();break;case"hints":this.drawSingleMarker(this.options.startLon,this.options.startLat),this._eventMapMoveZoomEnd(null),this.zoomToBestFit();break;case"searchresults":this.activateFacetedSearch(),this.drawSearchMarkers(searchResults),this.zoomToBestFit();break;default:this._eventMapMoveZoomEnd(null),this.zoomToBestFit()}},newMarkersLayer:function(){this.markersLayer?(this.markersLayer.destroy(),this.createMarkersLayer()):this.createMarkersLayer(),this.map.addLayer(this.markersLayer)},createMarkersLayer:function(){this.markersLayer=new OpenLayers.Layer.Markers("Reports",{projection:new OpenLayers.Projection("EPSG:4326"),visibility:!0,displayInLayerSwitcher:!1})},newFeatures:function(){var b=this;b.features&&a.each(b.features,function(){this.destroy(),this.destroyPopup()}),b.features=[]},zoomToBestFit:function(){var a=this;b.setTimeout(function(){var b=a.bounds.getCenterLonLat();a.map.setCenter(b,a.map.getZoomForExtent(a.bounds))},1e3)},drawMarkers:function(b,c,d){var e=this,f,g=new OpenLayers.Size(21,25),h=new OpenLayers.Pixel(-(g.w/2),-g.h);c==="red"?f="marker.png":c==="blue"&&(f="marker-blue.png"),d!==!0&&e.newFeatures(),a.each(b,function(){var b,c,d,i,j;b=new OpenLayers.LonLat(parseFloat(this.lon),parseFloat(this.lat)),b.transform(new OpenLayers.Projection("EPSG:4326"),e.map.getProjectionObject()),e.bounds.extend(b),c=new OpenLayers.Feature(e.markersLayer,b),c.closeBox=!0,c.popupClass=OpenLayers.Class(OpenLayers.Popup.Anchored,{autoSize:!0}),c.data.popupContentHTML=this.html,c.data.overflow="auto",c.data.icon=new OpenLayers.Icon(a.baseURL+"3rdparty/openlayers/img/"+f,g,h),d=c.createMarker(),i={that:e,feature:c},d.events.register("mousedown",i,e._eventMarkerMousedown),e.markersLayer.addMarker(d),c.popup=c.createPopup(c.closeBox),e.map.addPopup(c.popup),c.popup.hide(),e.features.push(c)})},drawSearchMarkers:function(b){var c=[],d;a.each(b,function(a,b){d={lon:this.lon,lat:this.lat,html:"<h3>"+this.bikeType+"</h3><p>"+"<strong>City:</strong><br /> "+this.city+"<br />"+"<strong>Color:</strong><br /> "+this.color+"<br /><br />"+'<a href="index.php?action=reportDetails&amp;reportID='+a+'">Show Reportdetails</a>'},c.push(d)}),this.drawMarkers(c,"red")},activateFacetedSearch:function(){var b=this,c=a("#faceted-search"),d=c.find('input[type="checkbox"]');c.length&&d.length&&(d.on("click",function(a){c.submit()}),a(".show-more-factet-options").on("click",function(b){b.preventDefault();var c=a(this);c.text()==="More..."?(c.parent().find(".hidden").toggleClass("hidden").toggleClass("hidemeagain"),c.text("Less...")):(c.parent().find(".hidemeagain").toggleClass("hidden").toggleClass("hidemeagain"),c.text("More..."))}))},drawSingleMarker:function(a,b){this.singleMarker&&this.singleMarker.destroy(),this.singleMarker=new OpenLayers.Marker((new OpenLayers.LonLat(a,b)).transform(this.options.mapOptions.displayProjection,this.options.mapOptions.projection)),this.bounds.extend((new OpenLayers.LonLat(a,b)).transform(this.options.mapOptions.displayProjection,this.options.mapOptions.projection)),this.markersLayer.addMarker(this.singleMarker)},drawSingleHintMarker:function(b,c){var d=new OpenLayers.Size(21,25),e=new OpenLayers.Pixel(-(d.w/2),-d.h),f=new OpenLayers.Icon(a.baseURL+"3rdparty/openlayers/img/marker-blue.png",d,e);this.singleHintMarker&&this.singleHintMarker.destroy(),this.singleHintMarker=new OpenLayers.Marker((new OpenLayers.LonLat(b,c)).transform(this.options.mapOptions.displayProjection,this.options.mapOptions.projection),f),this.markersLayer.addMarker(this.singleHintMarker)},zoomMapToCenter:function(a,b){var c=new OpenLayers.LonLat(a,b);c.transform(this.options.mapOptions.displayProjection,this.map.getProjectionObject()),this.map.setCenter(c,this.options.mapOptions.zoom)},geolocate:function(){var b=this,c=new OpenLayers.Control.Geolocate({bind:!1,geolocationOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:7e3}});b.map.addControl(c),c.events.register("locationupdated",c,function(a){b.zoomMapToCenter(a.position.coords.longitude,a.position.coords.latitude),b._reverseLonLatLookup(a.position.coords.longitude,a.position.coords.latitude)}),a(".btn-findme").on("click",function(a){a.preventDefault(),c.deactivate(),c.activate()})},registerDefaultEvents:function(){this.map.events.register("moveend",this,this._eventMapMoveZoomEnd),this.map.events.register("zomeend",this,this._eventMapMoveZoomEnd)},registerReportEvents:function(){var b=this,c=this.$road.add(this.$postcode).add(this.$city);c.on("keyup",a.debounce(500,function(a){a.preventDefault();var c=b.$road.val().length,d=b.$postcode.val().length,e=b.$city.val().length;(c>3||d>2||e>3)&&b._lonLatLookup()})),this.map.events.register("click",this,this._eventMapClick)},registerAddHintEvents:function(){this.map.events.register("click",this,this._eventAddHintMapClick)},getReportsInArea:function(b,c,d,e){var f=this;a("#finished").length||a('<div id="finished" class="hidden" />').appendTo("body"),a.getJSON(a.baseURL+"index.php",{action:"reportsInArea",left:b,right:c,top:d,bottom:e},function(b){var c=[],d;a.each(b,function(){var a=this.reportID;d={lon:this.lon,lat:this.lat,html:"<h3>"+this.bikeType+"</h3><p>"+"<strong>Color:</strong><br /> "+this.color+"<br />"+"<strong>Noticed Theft:</strong><br /> "+this.noticedTheft+"<br /><br />"+'<a href="index.php?action=reportDetails&reportID='+a+'">Show Reportdetails</a>'},c.push(d)}),f.drawMarkers(c,"red",!0),a("#finished").addClass("finished-reports")}),a.getJSON(a.baseURL+"index.php",{action:"hints"},function(b){var c=[],d;a.each(b,function(){d={lon:this.lon,lat:this.lat,html:"<h3>Hint by "+this.hintUser+"</h3><p>"+"<strong>Time of observation:</strong><br /> "+this.hintWhen+"<br />"+"<strong>Hint given on:</strong><br /> "+this.created+"<br />"+"<strong>Hint:</strong><br />"+this.hintWhat+'<br /><br /><a href="index.php?action=reportDetails&amp;reportID='+this.reportID+'">Show Reportdetails</a></p>'},c.push(d)}),f.drawMarkers(c,"blue",!0),a("#finished").addClass("finished-hints")})},getHints:function(b){var c=this;a.getJSON(a.baseURL+"index.php",{action:"hints",reportID:b},function(e){var f=[],g;a.each(e,function(){g={lon:this.lon,lat:this.lat,html:"<h3>Hint by "+this.hintUser+"</h3><p>"+"<strong>Time of observation:</strong><br /> "+this.hintWhen+"<br />"+"<strong>Hint given on:</strong><br /> "+this.created+"<br />"+this.hintWhat+'<br /><br /><a href="index.php?action=reportDetails&amp;reportID='+b+'">Show Reportdetails</a></p>'},f.push(g)}),c.drawMarkers(f,"blue"),a("#report-details-view").find(".nav-tabs li").removeClass("active"),a("#report-details-view").find(".tab-pane").removeClass("active"),c._getVariables("showHints")===d||c._getVariables("showHints")!=="true"?(a("#report-details-view").find(".nav-tabs li").first().addClass("active"),a("#report-details-view").find(".tab-pane").first().addClass("active")):(a("#report-details-view").find(".nav-tabs li").first().next().addClass("active"),a("#report-details-view").find(".tab-pane").first().next().addClass("active"))})},_eventMarkerMousedown:function(a){var b=this.that,c=this.feature,d=c.createPopup(c.closeBox);b.currentPopup===null?(b.map.addPopup(d),d.show()):b.currentPopup.id===d.id&&b.currentPopup.visible()?b.currentPopup.hide():(b.currentPopup.hide(),b.currentPopup=null,b.map.addPopup(d),d.show()),b.currentPopup=d,OpenLayers.Event.stop(a)},_eventMapMoveZoomEnd:function(a){var b=this.map.getExtent().transform(this.map.projection,this.map.displayProjection);switch(this.options.mapType){case"report":this.getReportsInArea(b.left,b.right,b.top,b.bottom);break;case"exploration":this.getReportsInArea(b.left,b.right,b.top,b.bottom);break;case"hints":this.getHints(this.options.report);break;default:}},_eventAddHintMapClick:function(a){var b=this.map.getLonLatFromViewPortPx(a.xy);b.transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")),this.drawSingleHintMarker(b.lon,b.lat),this.$lon.val(b.lon),this.$lat.val(b.lat)},_eventMapClick:function(a){var b=this.map.getLonLatFromViewPortPx(a.xy);b.transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")),this.drawSingleMarker(b.lon,b.lat),this.$lon.val(b.lon),this.$lat.val(b.lat),this._reverseLonLatLookup(b.lon,b.lat)},_reverseLonLatLookup:function(b,c){var d=this;a.getJSON("http://nominatim.openstreetmap.org/reverse?format=json&lat="+c+"&lon="+b+"&zoom=18&addressdetails=1",function(a){d._setAddressValues(a)})},_lonLatLookup:function(){var b=this,c="<h2>Did you mean...</h2>",d="http://nominatim.openstreetmap.org/search/"+b.$postcode.val()+" "+b.$city.val()+"/"+b.$road.val()+"/"+b.$house_number.val()+"?format=json&polygon=1&addressdetails=1&osm_type=N";d=encodeURI(d),a.getJSON(d,function(d){b.suggested=[],a.each(d,function(){b.suggested[this.place_id]=this,c+='<a class="suggest-link" href="place_id#'+this.place_id+'">'+this.display_name+"</a><br />"}),b.$suggestions.html(c),a(".suggest-link").on("click",function(c){c.preventDefault();var d=a(this).attr("href").replace("place_id#",""),e=b.suggested[d];b._setAddressValues(e),b.drawSingleMarker(e.lon,e.lat),b.zoomMapToCenter(e.lon,e.lat)})})},_setAddressValues:function(a){this.$road.val(a.address.road),this.$house_number.val(a.address.house_number),this.$postcode.val(a.address.postcode),this.$city.val(a.address.city),this.$lon.val(a.lon),this.$lat.val(a.lat)},_getVariables:function(a){var c={},d=b.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,b,d){c[b]=d});return c[a]}}),a.fn[e]=function(b){var c=arguments;if(b===d||typeof b=="object")return this.each(function(){a.data(this,"bikemap_"+e)||a.data(this,"bikemap_"+e,new g(this,b))});if(typeof b=="string"&&b[0]!=="_"&&b!=="init")return this.each(function(){var d=a.data(this,"bikemap_"+e);d instanceof g&&typeof d[b]=="function"&&d[b].apply(d,Array.prototype.slice.call(c,1))})}})(jQuery,window,document),$(document).ready(function(){function b(){$('#view-report input[required="required"]').each(function(){var a=$(this),b=$.trim(a.val()),c=a.parents(".tab-pane").attr("id"),d=$('#nav-report a[href="#'+c+'"]').find(".badge");b.length===0?(a.addClass("error"),d.addClass("badge-important"),$("#summary-"+a.attr("id")).text("Please enter a correct value").addClass("alert")):(a.removeClass("error"),d.removeClass("badge-important").addClass("badge-success"),$("#summary-"+a.attr("id")).removeClass("alert"))})}function c(){$(".summary-components-container").html("");var a="",b="";$('#view-report input[type="text"], #view-report input[type="file"], #view-report textarea').each(function(){var c=$(this),d="#summary-"+c.attr("id");if(c.attr("type")==="file")c.val().length&&(b+=c.val()+": "+c.val()+"<br />");else if(c.attr("name")==="comptype[]"||c.attr("name")==="compname[]"){if(c.attr("name")==="comptype[]"){var e=c.parent().data("bikeparts-counter");c.val().length&&(a+=c.val()+": "+$("#compname-"+e).val()+"<br />")}}else $(d).text(c.val())}),$(".summary-components-container").html(a),$(".summary-images-container").html(b)}function d(a){var b=a.parent(),c=b.clone(),e=b.data("upload-counter");c.insertAfter(b),a.remove(),e+=1,c.attr("data-upload-counter",e),c.find("label").attr("for","bikeimage-"+e),c.find("input").attr("id","bikeimage-"+e).val(""),c.find(".counter").text(e),c.find("button").on("click",function(a){a.preventDefault(),d($(this))})}function e(a){var b=a.parent(),c=b.clone(),d=b.data("bikeparts-counter");c.insertAfter(b),a.remove(),d+=1,c.attr("data-bikeparts-counter",d),c.find('label[for^="comptype"]').attr("for","comptype-"+d),c.find('label[for^="compname"]').attr("for","compname-"+d),c.find('input[id^="comptype"]').attr("id","comptype-"+d).val("").focus(),c.find('input[id^="compname"]').attr("id","compname-"+d).val(""),c.find("button").on("click",function(a){a.preventDefault(),e($(this))})}if($(".bikemap").length){var a=$(".bikemap");a.each(function(){var a,b,c,d={},e=$(this).data("bikemaptype");e==="exploration"?d={zoom:4}:e==="searchresults"?d={zoom:4}:e==="report"?d={zoom:15}:e==="report-details"?d={zoom:15,startLon:$(this).data("bikemaplon"),startLat:$(this).data("bikemaplat")}:e==="add-hint"?d={zoom:15,startLon:$(this).data("bikemaplon"),startLat:$(this).data("bikemaplat")}:e==="hints"&&(d={zoom:15,report:$(this).data("bikemapreportid"),startLon:$(this).data("bikemaplon"),startLat:$(this).data("bikemaplat")}),$(this).bikemap(d)})}$(".btn-print").on("click",function(a){a.preventDefault(),window.print()}),$("a.lightbox").length&&$("a.lightbox").colorbox({opacity:.8,loop:!1,maxWidth:"90%",maxHeight:"90%"}),$(".table-sortable").tablesorter(),$(".stolen-bike").length&&($(".stolen-bike").on("mouseenter",function(a){$(this).find(".stolen-image").removeClass("hidden")}),$(".stolen-bike").on("mouseleave",function(a){$(this).find(".stolen-image").addClass("hidden")})),$("#hint-form").length&&($("#hint-form").hide(),$(".btn-hint").on("click",function(a){a.preventDefault(),$.colorbox({inline:!0,href:"#hint-form",width:850,height:580,onComplete:function(){$("#colorbox #hint-form").show()},onClosed:function(){$("#hint-form").hide()}})})),$("#nav-report a").on("click",function(a){a.preventDefault(),$(this).tab("show")}),$("#lastSeen, #noticedTheft, #hintWhen").datetimepicker({firstDay:1,showAnim:"fade",maxDate:"0d",dateFormat:"dd.mm.yy",timeFormat:"hh:mm",stepMinute:5}),$(".suggestion").length&&$(".suggestion").each(function(){var a=$(this).attr("id"),b=a.split("-"),c=b[0];$(this).autocomplete({source:"index.php?action=suggestion&type="+c})}),$(".btn-add-more-images").on("click",function(a){a.preventDefault(),d($(this))}),$(".btn-add-more-parts").on("click",function(a){a.preventDefault(),e($(this))}),$("#view-report").length&&$('#nav-report a[href="#summary"]').on("click",function(a){c(),b()}),$(".btn-home-boxes").length&&$(".btn-home-boxes").on("click",function(a){a.preventDefault(),$(".sidebar .box").toggleClass("hidden")})});